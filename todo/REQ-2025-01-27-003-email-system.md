# ç”¨æˆ·æ¬¢è¿é‚®ä»¶ç³»ç»Ÿéœ€æ±‚è¯¦ç»†åˆ†è§£

## åŸºæœ¬ä¿¡æ¯

**éœ€æ±‚ç¼–å·**: REQ-2025-01-27-003  
**éœ€æ±‚æ ‡é¢˜**: æ–°ç”¨æˆ·æ³¨å†Œæ¬¢è¿é‚®ä»¶ç³»ç»Ÿ  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-27  
**åˆ›å»ºäºº**: å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-01-27  

## éœ€æ±‚åˆ†ç±»

**Epic**: ç”¨æˆ·ç•™å­˜ä¼˜åŒ– ğŸ“§  
**ä¼˜å…ˆçº§**: ğŸŸ¡ P2 (Medium)  
**éœ€æ±‚ç±»å‹**: åŠŸèƒ½éœ€æ±‚  
**Story Points**: 8  

## ç”¨æˆ·æ•…äº‹

**ä½œä¸º** æ–°æ³¨å†Œç”¨æˆ·  
**æˆ‘å¸Œæœ›** æ”¶åˆ°ä¸€å°ä»‹ç» GAIDN å¹³å°çš„æ¬¢è¿é‚®ä»¶  
**ä»¥ä¾¿** äº†è§£å¹³å°åŠŸèƒ½å’Œä»·å€¼ï¼Œå¿«é€Ÿä¸Šæ‰‹ä½¿ç”¨äº§å“  

## ä¸šåŠ¡ä»·å€¼

**ä¸šåŠ¡ç›®æ ‡**: 
- æé«˜æ–°ç”¨æˆ·æ¿€æ´»ç‡å’Œç•™å­˜ç‡
- å»ºç«‹ä¸ç”¨æˆ·çš„æ²Ÿé€šæ¸ é“
- ä¼ è¾¾å¹³å°ä»·å€¼å’Œä½¿ç”¨æŒ‡å¯¼
- åŸ¹å…»ç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯

**æˆåŠŸæŒ‡æ ‡**: 
- æ–°ç”¨æˆ· 7 å¤©æ¿€æ´»ç‡æå‡è‡³ 60%
- æ¬¢è¿é‚®ä»¶æ‰“å¼€ç‡ > 25%
- é‚®ä»¶ä¸­é“¾æ¥ç‚¹å‡»ç‡ > 10%
- ç”¨æˆ·åé¦ˆå“åº”ç‡æå‡ 40%

**é¢„æœŸå½±å“**: 
- å‡å°‘æ–°ç”¨æˆ·æµå¤±ç‡
- æå‡ç”¨æˆ·å¯¹å¹³å°çš„è®¤çŸ¥åº¦
- å¢å¼ºç”¨æˆ·ä¸å¹³å°çš„è¿æ¥æ„Ÿ
- ä¸ºåç»­è¥é”€æ´»åŠ¨æ‰“ä¸‹åŸºç¡€

## è¯¦ç»†æè¿°

### åŠŸèƒ½æè¿°
å»ºç«‹å®Œæ•´çš„é‚®ä»¶å‘é€ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š
1. é‚®ä»¶æœåŠ¡é›†æˆ
2. æ¬¢è¿é‚®ä»¶æ¨¡æ¿è®¾è®¡
3. è‡ªåŠ¨è§¦å‘æœºåˆ¶
4. ä¸ªæ€§åŒ–å†…å®¹å®šåˆ¶
5. å‘é€çŠ¶æ€è·Ÿè¸ª

### ç”¨æˆ·åœºæ™¯
1. **æ–°ç”¨æˆ·æ³¨å†Œ**: ç”¨æˆ·å®Œæˆ GitHub ç™»å½•åï¼Œç³»ç»Ÿè‡ªåŠ¨å‘é€æ¬¢è¿é‚®ä»¶
2. **é‚®ä»¶æ¥æ”¶**: ç”¨æˆ·åœ¨ 5 åˆ†é’Ÿå†…æ”¶åˆ°ç²¾ç¾çš„æ¬¢è¿é‚®ä»¶
3. **å†…å®¹æµè§ˆ**: ç”¨æˆ·é˜…è¯»é‚®ä»¶äº†è§£å¹³å°åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•
4. **é“¾æ¥ç‚¹å‡»**: ç”¨æˆ·ç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥è¿”å›å¹³å°è¿›è¡Œæ“ä½œ
5. **åç»­è·Ÿè¸ª**: ç³»ç»Ÿè®°å½•é‚®ä»¶æ‰“å¼€å’Œç‚¹å‡»æ•°æ®ç”¨äºä¼˜åŒ–

### ä¸šåŠ¡è§„åˆ™
1. ä»…å‘æ–°æ³¨å†Œç”¨æˆ·å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆé¿å…é‡å¤å‘é€ï¼‰
2. æ ¹æ®ç”¨æˆ·åœ°åŒºå’Œè¯­è¨€åå¥½å‘é€å¯¹åº”ç‰ˆæœ¬
3. é‚®ä»¶å‘é€å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
4. ç”¨æˆ·å¯ä»¥é€‰æ‹©é€€è®¢é‚®ä»¶é€šçŸ¥
5. éµå¾ª GDPR å’Œååƒåœ¾é‚®ä»¶æ³•è§„

## éªŒæ”¶æ ‡å‡† (Definition of Done)

### åŠŸèƒ½æ ‡å‡†
- [ ] é›†æˆé‚®ä»¶æœåŠ¡æä¾›å•†ï¼ˆæ¨è Resendï¼‰
- [ ] è®¾è®¡ä¸­è‹±æ–‡ç‰ˆæœ¬çš„æ¬¢è¿é‚®ä»¶æ¨¡æ¿
- [ ] å®ç°æ–°ç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨å‘é€é‚®ä»¶
- [ ] æ”¯æŒä¸ªæ€§åŒ–å†…å®¹ï¼ˆç”¨æˆ·åã€æ³¨å†Œæ—¶é—´ç­‰ï¼‰
- [ ] å®ç°é‚®ä»¶å‘é€çŠ¶æ€è·Ÿè¸ªå’Œé‡è¯•æœºåˆ¶
- [ ] æä¾›é‚®ä»¶åå¥½è®¾ç½®åŠŸèƒ½
- [ ] å»ºç«‹é‚®ä»¶å‘é€æ—¥å¿—å’Œç›‘æ§
- [ ] å®ç°é€€è®¢åŠŸèƒ½å’Œé“¾æ¥

### æŠ€æœ¯æ ‡å‡†
- [ ] ä»£ç é€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- [ ] ä»£ç é€šè¿‡ Code Review
- [ ] ç¬¦åˆ TypeScript ä¸¥æ ¼æ¨¡å¼è¦æ±‚
- [ ] å…¼å®¹ Cloudflare Workers ç¯å¢ƒ
- [ ] é‚®ä»¶å‘é€æ€§èƒ½ç¬¦åˆè¦æ±‚ï¼ˆ< 30sï¼‰

### è´¨é‡æ ‡å‡†
- [ ] é‚®ä»¶åœ¨ä¸»æµé‚®ç®±å®¢æˆ·ç«¯æ˜¾ç¤ºæ­£å¸¸
- [ ] HTML å’Œçº¯æ–‡æœ¬ç‰ˆæœ¬éƒ½å¯ç”¨
- [ ] é‚®ä»¶å†…å®¹å‡†ç¡®æ— è¯¯ï¼Œé“¾æ¥å¯ç”¨
- [ ] åƒåœ¾é‚®ä»¶æ£€æµ‹é€šè¿‡
- [ ] éµå¾ªé‚®ä»¶è¥é”€æœ€ä½³å®è·µ

## æŠ€æœ¯è¦æ±‚

### æŠ€æœ¯æ ˆ
- **é‚®ä»¶æœåŠ¡**: Resendï¼ˆæ¨èï¼Œæ”¯æŒ Cloudflare Workersï¼‰
- **æ¨¡æ¿å¼•æ“**: React Email æˆ– Handlebars
- **é˜Ÿåˆ—ç³»ç»Ÿ**: Cloudflare Queues æˆ–å†…ç½®é‡è¯•æœºåˆ¶
- **æ•°æ®å­˜å‚¨**: D1 æ•°æ®åº“è®°å½•é‚®ä»¶å‘é€çŠ¶æ€
- **ç›‘æ§**: Cloudflare Analytics

### æŠ€æœ¯çº¦æŸ
- å¿…é¡»ä¸ Cloudflare Workers ç¯å¢ƒå…¼å®¹
- æ”¯æŒå¤§æ‰¹é‡é‚®ä»¶å‘é€
- ç¡®ä¿é‚®ä»¶é€è¾¾ç‡å’Œå‘é€é€Ÿåº¦
- éµå¾ªé‚®ä»¶æœåŠ¡å•†çš„ API é™åˆ¶

### æ€§èƒ½è¦æ±‚
- **é‚®ä»¶å‘é€æ—¶é—´**: < 30 ç§’
- **å‘é€æˆåŠŸç‡**: > 95%
- **é‚®ä»¶é€è¾¾ç‡**: > 90%
- **ç³»ç»Ÿå¯ç”¨æ€§**: > 99.5%

## è®¾è®¡è¦æ±‚

### é‚®ä»¶æ¨¡æ¿è®¾è®¡

#### 1. ä¸­æ–‡ç‰ˆæ¬¢è¿é‚®ä»¶æ¨¡æ¿
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ¬¢è¿åŠ å…¥ GAIDN - å…¨çƒAIå¼€å‘è€…ç½‘ç»œ</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <!-- å¤´éƒ¨ Logo -->
    <div style="text-align: center; margin-bottom: 30px;">
      <h1 style="color: #2563eb; font-size: 28px; margin: 0;">GAIDN</h1>
      <p style="color: #6b7280; margin: 5px 0;">å…¨çƒAIå¼€å‘è€…ç½‘ç»œ</p>
    </div>
    
    <!-- ä¸»è¦å†…å®¹ -->
    <div style="background: #f9fafb; padding: 30px; border-radius: 8px; margin-bottom: 30px;">
      <h2 style="color: #111827; margin-top: 0;">ğŸ‘‹ æ¬¢è¿ {{userName}}ï¼</h2>
      
      <p style="color: #374151; line-height: 1.6;">
        æ„Ÿè°¢æ‚¨åŠ å…¥ GAIDNï¼ˆGlobal AI Developer Networkï¼‰â€” å…¨çƒAIå¼€å‘è€…ç½‘ç»œï¼
        æˆ‘ä»¬å¾ˆé«˜å…´æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€å‘˜ã€‚
      </p>
      
      <p style="color: #374151; line-height: 1.6;">
        GAIDN è‡´åŠ›äºå»ºç«‹ä¸€ä¸ªè‡ªç”±åä½œã€å…¬å¼€é€æ˜çš„å¼€å‘è€…ç”Ÿæ€ç³»ç»Ÿã€‚
        åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥ï¼š
      </p>
      
      <ul style="color: #374151; line-height: 1.8;">
        <li>ğŸ“Š æŸ¥çœ‹æ‚¨çš„å¼€å‘è€…è¯„åˆ†å’Œæ’å</li>
        <li>ğŸ† åœ¨æ’è¡Œæ¦œä¸Šå±•ç¤ºæ‚¨çš„æˆå°±</li>
        <li>ğŸ‘¥ å‘ç°å’Œè¿æ¥ä¼˜ç§€çš„å¼€å‘è€…</li>
        <li>ğŸ” æ¢ç´¢æœ‰è¶£çš„å¼€æºé¡¹ç›®</li>
      </ul>
      
      <div style="text-align: center; margin: 30px 0;">
        <a href="{{profileUrl}}" 
           style="background: #2563eb; color: white; padding: 12px 24px; 
                  text-decoration: none; border-radius: 6px; display: inline-block;">
          æŸ¥çœ‹æˆ‘çš„èµ„æ–™
        </a>
      </div>
    </div>
    
    <!-- å¿«é€Ÿå¼€å§‹æŒ‡å— -->
    <div style="margin-bottom: 30px;">
      <h3 style="color: #111827;">ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
      <ol style="color: #374151; line-height: 1.8;">
        <li><a href="{{profileUrl}}">å®Œå–„æ‚¨çš„ä¸ªäººèµ„æ–™</a></li>
        <li><a href="{{leaderboardUrl}}">æŸ¥çœ‹å¼€å‘è€…æ’è¡Œæ¦œ</a></li>
        <li><a href="{{discordUrl}}">åŠ å…¥æˆ‘ä»¬çš„å¾®ä¿¡ç¾¤äº¤æµ</a></li>
      </ol>
    </div>
    
    <!-- è”ç³»ä¿¡æ¯ -->
    <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center;">
      <p style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">
        å…³æ³¨æˆ‘ä»¬çš„æœ€æ–°åŠ¨æ€ï¼š
      </p>
      <div style="margin-bottom: 20px;">
        <a href="{{wechatUrl}}" style="color: #2563eb; margin: 0 10px;">å¾®ä¿¡</a>
        <a href="{{githubUrl}}" style="color: #2563eb; margin: 0 10px;">GitHub</a>
        <a href="{{websiteUrl}}" style="color: #2563eb; margin: 0 10px;">å®˜ç½‘</a>
      </div>
      
      <p style="color: #9ca3af; font-size: 12px;">
        å¦‚æœæ‚¨ä¸æƒ³å†æ”¶åˆ°è¿™ç±»é‚®ä»¶ï¼Œå¯ä»¥ 
        <a href="{{unsubscribeUrl}}" style="color: #6b7280;">å–æ¶ˆè®¢é˜…</a>
      </p>
    </div>
  </div>
</body>
</html>
```

#### 2. è‹±æ–‡ç‰ˆæ¬¢è¿é‚®ä»¶æ¨¡æ¿
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Welcome to GAIDN - Global AI Developer Network</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <!-- Header -->
    <div style="text-align: center; margin-bottom: 30px;">
      <h1 style="color: #2563eb; font-size: 28px; margin: 0;">GAIDN</h1>
      <p style="color: #6b7280; margin: 5px 0;">Global AI Developer Network</p>
    </div>
    
    <!-- Main Content -->
    <div style="background: #f9fafb; padding: 30px; border-radius: 8px; margin-bottom: 30px;">
      <h2 style="color: #111827; margin-top: 0;">ğŸ‘‹ Welcome {{userName}}!</h2>
      
      <p style="color: #374151; line-height: 1.6;">
        Thank you for joining GAIDN (Global AI Developer Network)! 
        We're excited to have you as part of our community.
      </p>
      
      <p style="color: #374151; line-height: 1.6;">
        GAIDN is dedicated to building a free, collaborative, and transparent 
        developer ecosystem. Here, you can:
      </p>
      
      <ul style="color: #374151; line-height: 1.8;">
        <li>ğŸ“Š View your developer score and ranking</li>
        <li>ğŸ† Showcase your achievements on the leaderboard</li>
        <li>ğŸ‘¥ Discover and connect with excellent developers</li>
        <li>ğŸ” Explore interesting open-source projects</li>
      </ul>
      
      <div style="text-align: center; margin: 30px 0;">
        <a href="{{profileUrl}}" 
           style="background: #2563eb; color: white; padding: 12px 24px; 
                  text-decoration: none; border-radius: 6px; display: inline-block;">
          View My Profile
        </a>
      </div>
    </div>
    
    <!-- Quick Start Guide -->
    <div style="margin-bottom: 30px;">
      <h3 style="color: #111827;">ğŸš€ Quick Start</h3>
      <ol style="color: #374151; line-height: 1.8;">
        <li><a href="{{profileUrl}}">Complete your profile</a></li>
        <li><a href="{{leaderboardUrl}}">Check out the developer leaderboard</a></li>
        <li><a href="{{discordUrl}}">Join our Discord community</a></li>
      </ol>
    </div>
    
    <!-- Contact Info -->
    <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center;">
      <p style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">
        Stay connected with us:
      </p>
      <div style="margin-bottom: 20px;">
        <a href="{{twitterUrl}}" style="color: #2563eb; margin: 0 10px;">Twitter</a>
        <a href="{{githubUrl}}" style="color: #2563eb; margin: 0 10px;">GitHub</a>
        <a href="{{websiteUrl}}" style="color: #2563eb; margin: 0 10px;">Website</a>
      </div>
      
      <p style="color: #9ca3af; font-size: 12px;">
        If you don't want to receive these emails, you can 
        <a href="{{unsubscribeUrl}}" style="color: #6b7280;">unsubscribe</a>
      </p>
    </div>
  </div>
</body>
</html>
```

## è¯¦ç»†å®æ–½æ–¹æ¡ˆ

### é˜¶æ®µä¸€ï¼šé‚®ä»¶æœåŠ¡é›†æˆ (Story Points: 3)

#### 1.1 å®‰è£…å’Œé…ç½® Resend
```bash
npm install resend
```

#### 1.2 åˆ›å»ºé‚®ä»¶æœåŠ¡ç±»
```typescript
// src/services/email.service.ts
import { Resend } from 'resend';

interface EmailData {
  to: string;
  subject: string;
  html: string;
  text?: string;
}

export class EmailService {
  private resend: Resend;

  constructor() {
    this.resend = new Resend(process.env.RESEND_API_KEY);
  }

  async sendWelcomeEmail(user: User, locale: 'zh' | 'en' = 'zh'): Promise<{
    success: boolean;
    messageId?: string;
    error?: string;
  }> {
    try {
      const template = await this.getWelcomeTemplate(user, locale);
      
      const { data, error } = await this.resend.emails.send({
        from: 'GAIDN <welcome@gaidn.org>',
        to: [user.email],
        subject: template.subject,
        html: template.html,
        text: template.text,
      });

      if (error) {
        console.error('é‚®ä»¶å‘é€å¤±è´¥:', error);
        return { success: false, error: error.message };
      }

      // è®°å½•å‘é€çŠ¶æ€åˆ°æ•°æ®åº“
      await this.logEmailSent(user.id, 'welcome', data.id);

      return { success: true, messageId: data.id };
    } catch (error) {
      console.error('é‚®ä»¶å‘é€å¼‚å¸¸:', error);
      return { success: false, error: error.message };
    }
  }

  private async getWelcomeTemplate(user: User, locale: 'zh' | 'en') {
    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://gaidn.org';
    const profileUrl = `${baseUrl}/${locale}/profile/${user.name}`;
    const leaderboardUrl = `${baseUrl}/${locale}/leaderboard`;
    const unsubscribeUrl = `${baseUrl}/api/unsubscribe?token=${user.id}&email=${user.email}`;

    const templates = {
      zh: {
        subject: `æ¬¢è¿åŠ å…¥ GAIDNï¼Œ${user.name}ï¼ğŸ‰`,
        html: await this.renderTemplate('welcome-zh', {
          userName: user.name,
          profileUrl,
          leaderboardUrl,
          unsubscribeUrl,
          wechatUrl: 'https://gaidn.org/wechat',
          githubUrl: 'https://github.com/gaidn',
          websiteUrl: baseUrl,
        }),
      },
      en: {
        subject: `Welcome to GAIDN, ${user.name}! ğŸ‰`,
        html: await this.renderTemplate('welcome-en', {
          userName: user.name,
          profileUrl,
          leaderboardUrl,
          unsubscribeUrl,
          twitterUrl: 'https://twitter.com/gaidn',
          githubUrl: 'https://github.com/gaidn',
          websiteUrl: baseUrl,
        }),
      },
    };

    return templates[locale];
  }
}
```

#### 1.3 åˆ›å»ºæ•°æ®åº“è¡¨
```sql
-- é‚®ä»¶å‘é€è®°å½•è¡¨
CREATE TABLE email_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  email_type TEXT NOT NULL,
  message_id TEXT,
  status TEXT NOT NULL DEFAULT 'sent',
  sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  opened_at DATETIME,
  clicked_at DATETIME,
  FOREIGN KEY (user_id) REFERENCES users (id)
);

-- é‚®ä»¶åå¥½è®¾ç½®è¡¨
CREATE TABLE email_preferences (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL UNIQUE,
  welcome_emails BOOLEAN DEFAULT true,
  marketing_emails BOOLEAN DEFAULT true,
  notification_emails BOOLEAN DEFAULT true,
  unsubscribed_at DATETIME,
  FOREIGN KEY (user_id) REFERENCES users (id)
);
```

### é˜¶æ®µäºŒï¼šè§¦å‘æœºåˆ¶é›†æˆ (Story Points: 2)

#### 2.1 åœ¨ç”¨æˆ·æ³¨å†Œæµç¨‹ä¸­é›†æˆé‚®ä»¶å‘é€
```typescript
// src/auth/handler.ts ä¸­çš„ handleSignInUser å‡½æ•°
export async function handleSignInUser(user: any, account: any): Promise<User | null> {
  // ... ç°æœ‰çš„ç”¨æˆ·åˆ›å»ºé€»è¾‘

  // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç”¨æˆ·
  if (isNewUser) {
    // å¼‚æ­¥å‘é€æ¬¢è¿é‚®ä»¶ï¼Œä¸é˜»å¡ç™»å½•æµç¨‹
    setImmediate(async () => {
      try {
        const emailService = new EmailService();
        const locale = detectUserLocale(user); // æ£€æµ‹ç”¨æˆ·è¯­è¨€åå¥½
        
        const result = await emailService.sendWelcomeEmail(savedUser, locale);
        
        if (result.success) {
          console.log(`âœ… æ¬¢è¿é‚®ä»¶å·²å‘é€ç»™ç”¨æˆ· ${savedUser.name}`);
        } else {
          console.error(`âŒ æ¬¢è¿é‚®ä»¶å‘é€å¤±è´¥:`, result.error);
        }
      } catch (error) {
        console.error('å‘é€æ¬¢è¿é‚®ä»¶å¼‚å¸¸:', error);
      }
    });
  }

  return savedUser;
}

function detectUserLocale(user: any): 'zh' | 'en' {
  // æ ¹æ®ç”¨æˆ·ä¿¡æ¯æ£€æµ‹è¯­è¨€åå¥½
  // å¯ä»¥åŸºäºåœ°ç†ä½ç½®ã€GitHub è¯­è¨€è®¾ç½®ç­‰
  return 'zh'; // é»˜è®¤ä¸­æ–‡
}
```

#### 2.2 åˆ›å»ºé‡è¯•æœºåˆ¶
```typescript
// src/services/email-queue.service.ts
export class EmailQueueService {
  async addToQueue(emailTask: EmailTask): Promise<void> {
    // ä½¿ç”¨ Cloudflare Queues æˆ–ç®€å•çš„é‡è¯•æœºåˆ¶
    await this.scheduleEmailSend(emailTask, 0);
  }

  private async scheduleEmailSend(task: EmailTask, attempt: number): Promise<void> {
    const maxRetries = 3;
    const retryDelays = [0, 60000, 300000]; // 0s, 1min, 5min

    if (attempt > maxRetries) {
      console.error(`é‚®ä»¶å‘é€æœ€ç»ˆå¤±è´¥ï¼Œä»»åŠ¡ID: ${task.id}`);
      return;
    }

    setTimeout(async () => {
      const emailService = new EmailService();
      const result = await emailService.sendWelcomeEmail(task.user, task.locale);

      if (!result.success) {
        console.warn(`é‚®ä»¶å‘é€å¤±è´¥ï¼Œç¬¬ ${attempt + 1} æ¬¡å°è¯•ï¼Œå°†é‡è¯•...`);
        await this.scheduleEmailSend(task, attempt + 1);
      }
    }, retryDelays[attempt] || 0);
  }
}
```

### é˜¶æ®µä¸‰ï¼šç›‘æ§å’Œåˆ†æ (Story Points: 2)

#### 3.1 åˆ›å»ºé‚®ä»¶ç»Ÿè®¡ API
```typescript
// src/app/api/email/stats/route.ts
export async function GET(request: Request) {
  try {
    const db = await getDB();
    
    const stats = await db.prepare(`
      SELECT 
        COUNT(*) as total_sent,
        COUNT(opened_at) as total_opened,
        COUNT(clicked_at) as total_clicked,
        AVG(CASE WHEN opened_at IS NOT NULL THEN 1 ELSE 0 END) as open_rate,
        AVG(CASE WHEN clicked_at IS NOT NULL THEN 1 ELSE 0 END) as click_rate
      FROM email_logs 
      WHERE email_type = 'welcome'
      AND sent_at >= datetime('now', '-7 days')
    `).first();

    return Response.json({ success: true, data: stats });
  } catch (error) {
    return Response.json({ success: false, error: error.message }, { status: 500 });
  }
}
```

#### 3.2 åˆ›å»ºé€€è®¢åŠŸèƒ½
```typescript
// src/app/api/unsubscribe/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const token = searchParams.get('token');
  const email = searchParams.get('email');

  try {
    const db = await getDB();
    
    // éªŒè¯ç”¨æˆ·èº«ä»½å¹¶æ›´æ–°åå¥½è®¾ç½®
    await db.prepare(`
      INSERT OR REPLACE INTO email_preferences 
      (user_id, welcome_emails, marketing_emails, notification_emails, unsubscribed_at)
      VALUES (?, false, false, false, datetime('now'))
    `).run(token);

    return new Response(`
      <html>
        <body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;">
          <h2>é€€è®¢æˆåŠŸ</h2>
          <p>æ‚¨å·²æˆåŠŸé€€è®¢ GAIDN çš„é‚®ä»¶é€šçŸ¥ã€‚</p>
          <p>å¦‚éœ€é‡æ–°è®¢é˜…ï¼Œè¯·ç™»å½•æ‚¨çš„è´¦æˆ·è¿›è¡Œè®¾ç½®ã€‚</p>
        </body>
      </html>
    `, {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  } catch (error) {
    return Response.json({ success: false, error: error.message }, { status: 500 });
  }
}
```

### é˜¶æ®µå››ï¼šä¸ªæ€§åŒ–å†…å®¹ (Story Points: 1)

#### 4.1 æ ¹æ®ç”¨æˆ·åœ°åŒºå®šåˆ¶å†…å®¹
```typescript
function getLocalizedContent(user: User, locale: 'zh' | 'en') {
  const socialLinks = {
    zh: {
      primary: 'wechat',
      links: {
        wechat: 'https://gaidn.org/wechat',
        weibo: 'https://weibo.com/gaidn',
        zhihu: 'https://zhihu.com/people/gaidn'
      }
    },
    en: {
      primary: 'discord',
      links: {
        discord: 'https://discord.gg/gaidn',
        twitter: 'https://twitter.com/gaidn',
        linkedin: 'https://linkedin.com/company/gaidn'
      }
    }
  };

  return socialLinks[locale];
}
```

## ä¾èµ–å…³ç³»

### å‰ç½®æ¡ä»¶
- [ ] ç”¨æˆ·æ³¨å†Œæµç¨‹ç¨³å®šè¿è¡Œ
- [ ] ç”¨æˆ·é‚®ç®±ä¿¡æ¯å‡†ç¡®è·å–
- [ ] Resend è´¦æˆ·ç”³è¯·å’Œ API å¯†é’¥è·å–
- [ ] åŸŸåé‚®ä»¶å‘é€æˆæƒé…ç½®

### é˜»å¡å› ç´ 
- Resend æœåŠ¡çš„ç¨³å®šæ€§å’Œé…é¢é™åˆ¶
- é‚®ä»¶æ¨¡æ¿è®¾è®¡å’Œå†…å®¹å®¡æ ¸æ—¶é—´
- å„é‚®ç®±æä¾›å•†çš„åƒåœ¾é‚®ä»¶æ”¿ç­–
- GDPR åˆè§„æ€§å®¡æŸ¥

### å½±å“èŒƒå›´
- ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼ˆå¢åŠ é‚®ä»¶å‘é€æ­¥éª¤ï¼‰
- æ•°æ®åº“æ¶æ„ï¼ˆæ–°å¢é‚®ä»¶ç›¸å…³è¡¨ï¼‰
- ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæ–°å¢é‚®ä»¶æœåŠ¡é…ç½®ï¼‰
- ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

## é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©
| é£é™©é¡¹ | å¯èƒ½æ€§ | å½±å“ç¨‹åº¦ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|--------|----------|----------|----------|
| é‚®ä»¶æœåŠ¡å¯ç”¨æ€§ | ä¸­ | é«˜ | ğŸŸ¡ | å®ç°é‡è¯•æœºåˆ¶ï¼Œç›‘æ§æœåŠ¡çŠ¶æ€ |
| åƒåœ¾é‚®ä»¶æ ‡è®° | ä¸­ | ä¸­ | ğŸŸ¡ | éµå¾ªæœ€ä½³å®è·µï¼Œé¢„çƒ­å‘é€åŸŸå |
| å‘é€é…é¢é™åˆ¶ | ä½ | ä¸­ | ğŸŸ¢ | ç›‘æ§ä½¿ç”¨é‡ï¼Œåˆ¶å®šæ‰©å®¹è®¡åˆ’ |
| æ¨¡æ¿æ¸²æŸ“æ€§èƒ½ | ä½ | ä½ | ğŸŸ¢ | ä¼˜åŒ–æ¨¡æ¿ï¼Œä½¿ç”¨ç¼“å­˜ |

### ä¸šåŠ¡é£é™©
| é£é™©é¡¹ | å¯èƒ½æ€§ | å½±å“ç¨‹åº¦ | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|--------|--------|----------|----------|----------|
| ç”¨æˆ·æŠ•è¯‰é‚®ä»¶ | ä¸­ | ä¸­ | ğŸŸ¡ | æä¾›æ¸…æ™°é€€è®¢é€‰é¡¹ï¼Œä¼˜åŒ–å†…å®¹ |
| é‚®ä»¶é€è¾¾ç‡ä½ | ä¸­ | é«˜ | ğŸŸ¡ | ç›‘æ§é€è¾¾ç‡ï¼Œä¼˜åŒ–å‘é€ç­–ç•¥ |
| å†…å®¹æœ¬åœ°åŒ–é—®é¢˜ | ä½ | ä¸­ | ğŸŸ¢ | ä¸“ä¸šç¿»è¯‘å®¡æ ¸ï¼Œç”¨æˆ·åé¦ˆæ”¶é›† |

## æµ‹è¯•è®¡åˆ’

### æµ‹è¯•èŒƒå›´
- [ ] å•å…ƒæµ‹è¯•ï¼šé‚®ä»¶æœåŠ¡ç±»å’Œæ¨¡æ¿æ¸²æŸ“
- [ ] é›†æˆæµ‹è¯•ï¼šä¸ç”¨æˆ·æ³¨å†Œæµç¨‹çš„é›†æˆ
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼šå®Œæ•´çš„é‚®ä»¶å‘é€å’Œæ¥æ”¶æµç¨‹
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå¤§é‡ç”¨æˆ·æ³¨å†Œæ—¶çš„é‚®ä»¶å‘é€æ€§èƒ½
- [ ] å…¼å®¹æ€§æµ‹è¯•ï¼šå„é‚®ç®±å®¢æˆ·ç«¯çš„æ˜¾ç¤ºæ•ˆæœ

### å…³é”®æµ‹è¯•ç”¨ä¾‹
| æµ‹è¯•åœºæ™¯ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|----------|----------|----------|--------|
| æ–°ç”¨æˆ·æ³¨å†Œ | å®Œæˆ GitHub ç™»å½•æ³¨å†Œ | 5åˆ†é’Ÿå†…æ”¶åˆ°æ¬¢è¿é‚®ä»¶ | é«˜ |
| é‚®ä»¶å†…å®¹æ˜¾ç¤º | åœ¨ä¸åŒé‚®ç®±å®¢æˆ·ç«¯æ‰“å¼€é‚®ä»¶ | å†…å®¹æ­£ç¡®æ˜¾ç¤ºï¼Œé“¾æ¥å¯ç”¨ | é«˜ |
| è¯­è¨€è‡ªåŠ¨è¯†åˆ« | ä¸åŒåœ°åŒºç”¨æˆ·æ³¨å†Œ | æ”¶åˆ°å¯¹åº”è¯­è¨€ç‰ˆæœ¬é‚®ä»¶ | ä¸­ |
| é‡è¯•æœºåˆ¶ | æ¨¡æ‹Ÿé‚®ä»¶å‘é€å¤±è´¥ | è‡ªåŠ¨é‡è¯•å‘é€ | ä¸­ |
| é€€è®¢åŠŸèƒ½ | ç‚¹å‡»é€€è®¢é“¾æ¥ | æˆåŠŸé€€è®¢ï¼Œæ˜¾ç¤ºç¡®è®¤é¡µé¢ | ä¸­ |

## å®æ–½è®¡åˆ’

### å¼€å‘é˜¶æ®µ
| é˜¶æ®µ | å·¥ä½œå†…å®¹ | é¢„è®¡å·¥æœŸ | è´Ÿè´£äºº |
|------|----------|----------|--------|
| æœåŠ¡é›†æˆ | é‚®ä»¶æœåŠ¡é…ç½®ï¼ŒAPI é›†æˆ | 2 å¤© | åç«¯å¼€å‘ |
| æ¨¡æ¿å¼€å‘ | é‚®ä»¶æ¨¡æ¿è®¾è®¡å’Œå®ç° | 2 å¤© | å‰ç«¯å¼€å‘ |
| æµç¨‹é›†æˆ | æ³¨å†Œæµç¨‹é›†æˆï¼Œè§¦å‘æœºåˆ¶ | 1 å¤© | å…¨æ ˆå¼€å‘ |
| ç›‘æ§å®Œå–„ | ç»Ÿè®¡åˆ†æï¼Œæ—¥å¿—ç›‘æ§ | 1 å¤© | åç«¯å¼€å‘ |
| æµ‹è¯•éªŒæ”¶ | å…¨é¢æµ‹è¯•ï¼Œé—®é¢˜ä¿®å¤ | 1 å¤© | æµ‹è¯•å·¥ç¨‹å¸ˆ |

### é‡Œç¨‹ç¢‘
- [ ] é‚®ä»¶æœåŠ¡é›†æˆå®Œæˆ - 2025-02-12
- [ ] æ¨¡æ¿å¼€å‘å®Œæˆ - 2025-02-14
- [ ] æ³¨å†Œæµç¨‹é›†æˆå®Œæˆ - 2025-02-15
- [ ] æµ‹è¯•éªŒæ”¶é€šè¿‡ - 2025-02-16

## ä¸Šçº¿æ ‡å‡†

### ä¸Šçº¿å‰æ£€æŸ¥æ¸…å•
- [ ] é‚®ä»¶åœ¨å„ä¸»æµé‚®ç®±å®¢æˆ·ç«¯æ˜¾ç¤ºæ­£å¸¸
- [ ] å‘é€æˆåŠŸç‡ > 95%
- [ ] åƒåœ¾é‚®ä»¶æ£€æµ‹é€šè¿‡
- [ ] é€€è®¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] é‡è¯•æœºåˆ¶éªŒè¯é€šè¿‡
- [ ] æ•°æ®åº“è¿ç§»å®Œæˆ
- [ ] ç›‘æ§å‘Šè­¦é…ç½®å®Œæˆ
- [ ] GDPR åˆè§„æ€§ç¡®è®¤
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡å°±ç»ª

### ä¸Šçº¿è®¡åˆ’
- **ä¸Šçº¿æ—¶é—´**: 2025-02-16 ä¸Šåˆ 10:00
- **ä¸Šçº¿æ–¹å¼**: ç°åº¦å‘å¸ƒï¼Œå…ˆå¯¹ 10% æ–°ç”¨æˆ·å¯ç”¨
- **å›æ»šæ–¹æ¡ˆ**: å¿«é€Ÿç¦ç”¨é‚®ä»¶å‘é€åŠŸèƒ½ï¼Œä¸å½±å“ç”¨æˆ·æ³¨å†Œ

## åç»­è·Ÿè¸ª

### æ•°æ®ç›‘æ§
- é‚®ä»¶å‘é€æˆåŠŸç‡å’Œå¤±è´¥ç‡
- é‚®ä»¶æ‰“å¼€ç‡å’Œç‚¹å‡»ç‡ç»Ÿè®¡
- ç”¨æˆ·é€€è®¢ç‡å’ŒæŠ•è¯‰ç‡
- æ–°ç”¨æˆ·æ¿€æ´»ç‡å˜åŒ–è¶‹åŠ¿

### ç”¨æˆ·åé¦ˆ
- æ”¶é›†ç”¨æˆ·å¯¹é‚®ä»¶å†…å®¹çš„åé¦ˆ
- è®°å½•é‚®ä»¶ç›¸å…³çš„æŠ€æœ¯é—®é¢˜
- å®šæœŸè¿›è¡Œé‚®ä»¶æ•ˆæœè°ƒç ”

### ä¼˜åŒ–è®¡åˆ’
- æ ¹æ®æ•°æ®ä¼˜åŒ–é‚®ä»¶å†…å®¹å’Œå‘é€æ—¶æœº
- è€ƒè™‘å¢åŠ æ›´å¤šç±»å‹çš„é‚®ä»¶é€šçŸ¥
- æ¢ç´¢ä¸ªæ€§åŒ–æ¨èå†…å®¹çš„å¯èƒ½æ€§
- ç ”ç©¶è‡ªåŠ¨åŒ–é‚®ä»¶è¥é”€ç­–ç•¥

---

## çŠ¶æ€è·Ÿè¸ª

**å½“å‰çŠ¶æ€**: ğŸ“‹ Todo

### çŠ¶æ€å˜æ›´å†å²
| æ—¥æœŸ | çŠ¶æ€å˜æ›´ | å˜æ›´åŸå›  | æ“ä½œäºº |
|------|----------|----------|--------|
| 2025-01-27 | - â†’ ğŸ“‹ Todo | éœ€æ±‚åˆ›å»º | å¼€å‘å›¢é˜Ÿ |

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æœ€åæ›´æ–°: 2025-01-27*